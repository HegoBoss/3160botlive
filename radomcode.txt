using Discord;
using Discord.WebSocket;
using System;
using System.Threading.Tasks;

namespace _3160robot.bot
{
    internal class Program
    {
        private readonly DiscordSocketClient _client;

        public Program()
        {
            // 1. Configure Intents (Required to read message content)
            var config = new DiscordSocketConfig
            {
                GatewayIntents = GatewayIntents.AllUnprivileged | GatewayIntents.MessageContent
            };

            _client = new DiscordSocketClient(config);

            // 2. Subscribe to events
            _client.Log += LogAsync;
            _client.MessageReceived += MessageHandler;
        }

        // 3. Modern Async Main method
        public static async Task Main(string[] args)
        {
            await new Program().StartBotAsync();
        }

        public async Task StartBotAsync()
        {
            // 4. Load Token securely (Set this in your Project Properties -> Debug -> Environment Variables)
            // Variable name: "DISCORD_TOKEN"
            string token = Environment.GetEnvironmentVariable("DISCORD_TOKEN");

            if (string.IsNullOrEmpty(token))
            {
                Console.WriteLine("Error: Token not found in Environment Variables.");
                return;
            }

            await _client.LoginAsync(TokenType.Bot, token);
            await _client.StartAsync();

            // Block this task until the program is closed.
            await Task.Delay(-1);
        }

        private Task LogAsync(LogMessage message)
        {
            Console.WriteLine(message.ToString());
            return Task.CompletedTask;
        }

        private async Task MessageHandler(SocketMessage message)
        {
            // Ignore messages from bots
            if (message.Author.IsBot) return;

            // Optional: Only reply if the message contains specific text? 
            // Currently, this replies to EVERY message.
            // if (message.Content.Contains("wie zijn schuld?")) 
            
            await message.Channel.SendMessageAsync("Altijd de schuld van Kenny!");
        }
    }
}